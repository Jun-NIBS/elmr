---
title: "Transforming between FAFB and light level template brains "
author: "Gregory Jefferis"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Transforming from FAFB to other templates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
## Intro

In combination with several other nat packages, elmr allows you to convert 3D 
objects (skeletons, surfaces, images) between FAFB EM space and a number of light
level template brains.

### Setup
In order to run some of the examples we need to ensure that we have CMTK 
available and the [nat.flybrains](https://github.com/jefferislab/nat.flybrains) 
package fully installed to provide bridging
registrations. We will make some of our examples run conditionally based on this.

```{r, message=FALSE}
full.bridging=FALSE
library(nat)
if(!nzchar(cmtk.bindir())){
  cat("CMTK not available! Some examples will not run.")
} else {
  djrok=try(nat.flybrains::download_jefferislab_registrations())
  if(inherits(djrok, "try-error")) 
    cat("Unable to download bridging registrations! Some examples will not run.")
  else full.bridging=TRUE
}
```


## Example - 3D locations

As our first example, we take the position of the centre of the left and right
olfactory V glomeruli (CO2 responsive). We transform these from JFRC2013 to 
FAFB12 space.

```{r, message=FALSE}
library(elmr)
vgloms.jfrc2013=data.frame(X=c(316,229),
  Y=c(143, 139),
  Z=c(26,22),
  row.names=c("V_L", "V_R"))
# Convert to FAFB12 coordinates
xform_brain(vgloms.jfrc2013, sample = JFRC2013, reference = FAFB12)
```

## Neurons

Our second example converts some neurons from a light level space other than
JFRC2013 to FAFB, making use of additional bridging registrations supplied by
the nat.flybrains package.

```{r, eval=full.bridging}
# Conversion of neurons from FlyCircuit template
# NB this conversion depends on a full install of nat.flybrains and CMTK
# ensure that we have all the relevant bridging registrations downloaded
Cell07PNs13.fafb=xform_brain(Cell07PNs[1:3], sample=IS2, reference=FAFB12)
plot(Cell07PNs13.fafb)
```

## Neurons + Surface
WIP
```{r}

```

