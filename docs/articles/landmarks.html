<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Landmarks • elmr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">elmr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jefferis/elmr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Landmarks</h1>
                        <h4 class="author">Gregory Jefferis</h4>
            
            <h4 class="date">2017-02-27</h4>
          </div>

    
    
<div class="contents">
<div id="intro" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#intro" class="anchor"> </a></body></html>Intro</h2>
<p>One of the core features of elmr is to enable data in the FAFB EM space to be transformed into one of a number of standard light level template brains. This transformation depends on manually selected landmarks. We can inspect these landmarks and to try to</p>
<div id="setup" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#setup" class="anchor"> </a></body></html>Setup</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(elmr)
<span class="kw">library</span>(knitr)
opts_chunk$<span class="kw">set</span>(<span class="dt">fig.width=</span><span class="dv">5</span>, <span class="dt">fig.height=</span><span class="dv">5</span>)
<span class="co"># set up for 3d plots based on rgl package</span>
rgl::<span class="kw">setupKnitr</span>()
<span class="co"># frontal view</span>
<span class="kw">view3d</span>(<span class="dt">userMatrix=</span>rgl::<span class="kw">rotationMatrix</span>(<span class="dt">angle =</span> pi, <span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">zoom=</span><span class="fl">0.7</span>)</code></pre></div>
</div>
</div>
<div id="landmarks" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#landmarks" class="anchor"> </a></body></html>Landmarks</h2>
<p>The standard landmarks used by elmr were specified by Davi Bock on the FAFB and JFRC2013 brains. We can plot the landmarks in the context of the JFRC2013 brain as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot3d</span>(JFRC2013)
<span class="co"># note that the landmarks are in raw voxel coordinates and must be scaled</span>
xyz=<span class="kw">scale</span>(elm.landmarks[,<span class="kw">c</span>(<span class="st">"X"</span>,<span class="st">"Y"</span>,<span class="st">"Z"</span>)], <span class="dt">scale =</span> <span class="dv">1</span>/<span class="kw">voxdims</span>(JFRC2013), <span class="dt">center =</span> <span class="ot">FALSE</span>)
xyz=<span class="kw">as.data.frame</span>(xyz)
<span class="kw">spheres3d</span>(xyz, <span class="dt">col =</span> <span class="kw">ifelse</span>(elm.landmarks$Use, <span class="st">"green"</span>, <span class="st">'red'</span>), <span class="dt">radius =</span> <span class="dv">4</span>)</code></pre></div>
<p><img src="landmarks_files/figure-html/unnamed-chunk-2-1.png" width="480"></p>
</div>
<div id="landmamarks-based-transform" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#landmamarks-based-transform" class="anchor"> </a></body></html>Landmamarks based transform</h2>
<p>The standard <code>elm.landmarks</code> set is used within to the elmr package to register a transformation that can map FAFB-&gt;JFRC2013 space in conjunction with the <code>xform_brain</code> functions provided by the <code>nat.templatebrains</code> packages.</p>
<p>Let’s first look at the FAFB landmarks</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># note that these positions are in nm units and do not need scaling</span>
xyz.fafb=elm.landmarks[,<span class="kw">c</span>(<span class="st">"X1"</span>,<span class="st">"Y1"</span>,<span class="st">"Z1"</span>)]
<span class="kw">kable</span>(<span class="kw">head</span>(xyz.fafb))</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">X1</th>
<th align="right">Y1</th>
<th align="right">Z1</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">591360.1</td>
<td align="right">287783.6</td>
<td align="right">97510.11</td>
</tr>
<tr class="even">
<td align="right">525666.5</td>
<td align="right">172470.4</td>
<td align="right">80994.73</td>
</tr>
<tr class="odd">
<td align="right">595391.6</td>
<td align="right">263523.1</td>
<td align="right">84156.77</td>
</tr>
<tr class="even">
<td align="right">501080.2</td>
<td align="right">253465.3</td>
<td align="right">98233.34</td>
</tr>
<tr class="odd">
<td align="right">528543.2</td>
<td align="right">338099.9</td>
<td align="right">19349.01</td>
</tr>
<tr class="even">
<td align="right">670999.9</td>
<td align="right">179097.9</td>
<td align="right">67561.69</td>
</tr>
</tbody>
</table>
<p>Now we can try to look at the consistency of the transform between each landmark pair as follows:</p>
<ol style="list-style-type: decimal">
<li>Drop out each landmark pair in turn</li>
<li>Calculate position of that landmark in target space using remaining landmark pairs</li>
<li>Measure difference between calculated position and manually defined position</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># record transformed position with leave one out</span>
xyzt.loo=xyz
for(i in <span class="dv">1</span>:<span class="kw">nrow</span>(xyz)) {
  thisreg &lt;-<span class="st"> </span><span class="kw">reglist</span>(<span class="kw"><a href="../reference/tpsreg.html">tpsreg</a></span>(xyz.fafb[-i, ], xyz[-i, ]))
  xyzt.loo[i,]=<span class="kw">xform</span>(xyz.fafb[i, , <span class="dt">drop=</span><span class="ot">FALSE</span>], thisreg)
}
deltas=<span class="kw">sqrt</span>(<span class="kw">rowSums</span>((xyzt.loo-xyz)^<span class="dv">2</span>))
<span class="kw">hist</span>(deltas)</code></pre></div>
<p><img src="landmarks_files/figure-html/unnamed-chunk-4-1.png" width="480"></p>
<p>Let’s looks at the deltas (distance between leave one out vs manually defined landmark position) for each point.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">kable</span>(<span class="kw">cbind</span>(elm.landmarks, <span class="dt">delta=</span>deltas))</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">Label</th>
<th align="left">Use</th>
<th align="right">X</th>
<th align="right">Y</th>
<th align="right">Z</th>
<th align="right">X1</th>
<th align="right">Y1</th>
<th align="right">Z1</th>
<th align="right">delta</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Pt-0</td>
<td align="left">TRUE</td>
<td align="right">702.1487</td>
<td align="right">285.40275</td>
<td align="right">209.73076</td>
<td align="right">591360.1</td>
<td align="right">287783.6</td>
<td align="right">97510.11</td>
<td align="right">4.495873</td>
</tr>
<tr class="even">
<td align="left">Pt-1</td>
<td align="left">TRUE</td>
<td align="right">571.4001</td>
<td align="right">38.85996</td>
<td align="right">287.05954</td>
<td align="right">525666.5</td>
<td align="right">172470.4</td>
<td align="right">80994.73</td>
<td align="right">4.439362</td>
</tr>
<tr class="odd">
<td align="left">Pt-2</td>
<td align="left">TRUE</td>
<td align="right">715.8113</td>
<td align="right">213.29936</td>
<td align="right">217.39349</td>
<td align="right">595391.6</td>
<td align="right">263523.1</td>
<td align="right">84156.77</td>
<td align="right">2.110814</td>
</tr>
<tr class="even">
<td align="left">Pt-3</td>
<td align="left">TRUE</td>
<td align="right">513.0022</td>
<td align="right">198.00197</td>
<td align="right">217.79409</td>
<td align="right">501080.2</td>
<td align="right">253465.3</td>
<td align="right">98233.34</td>
<td align="right">6.576990</td>
</tr>
<tr class="odd">
<td align="left">Pt-5</td>
<td align="left">TRUE</td>
<td align="right">602.0898</td>
<td align="right">271.07851</td>
<td align="right">17.30991</td>
<td align="right">528543.2</td>
<td align="right">338099.9</td>
<td align="right">19349.01</td>
<td align="right">11.787314</td>
</tr>
<tr class="even">
<td align="left">Pt-6</td>
<td align="left">TRUE</td>
<td align="right">867.0125</td>
<td align="right">31.91925</td>
<td align="right">276.22344</td>
<td align="right">670999.9</td>
<td align="right">179097.9</td>
<td align="right">67561.69</td>
<td align="right">4.625576</td>
</tr>
<tr class="odd">
<td align="left">Pt-7</td>
<td align="left">TRUE</td>
<td align="right">935.2109</td>
<td align="right">234.22952</td>
<td align="right">351.51807</td>
<td align="right">702703.9</td>
<td align="right">251846.4</td>
<td align="right">127865.89</td>
<td align="right">7.413386</td>
</tr>
<tr class="even">
<td align="left">Pt-8</td>
<td align="left">TRUE</td>
<td align="right">935.2109</td>
<td align="right">232.62607</td>
<td align="right">405.50079</td>
<td align="right">702633.2</td>
<td align="right">250322.0</td>
<td align="right">162468.60</td>
<td align="right">11.278113</td>
</tr>
<tr class="odd">
<td align="left">Pt-9</td>
<td align="left">TRUE</td>
<td align="right">935.2109</td>
<td align="right">143.90200</td>
<td align="right">414.05251</td>
<td align="right">702633.2</td>
<td align="right">201876.1</td>
<td align="right">160251.58</td>
<td align="right">11.335541</td>
</tr>
<tr class="even">
<td align="left">Pt-10</td>
<td align="left">TRUE</td>
<td align="right">509.7629</td>
<td align="right">244.91917</td>
<td align="right">362.20772</td>
<td align="right">504182.4</td>
<td align="right">244953.7</td>
<td align="right">148700.67</td>
<td align="right">10.118559</td>
</tr>
<tr class="odd">
<td align="left">Pt-11</td>
<td align="left">TRUE</td>
<td align="right">509.2284</td>
<td align="right">281.12828</td>
<td align="right">403.48102</td>
<td align="right">504050.2</td>
<td align="right">252491.4</td>
<td align="right">181628.86</td>
<td align="right">5.534175</td>
</tr>
<tr class="even">
<td align="left">Pt-12</td>
<td align="left">TRUE</td>
<td align="right">509.2284</td>
<td align="right">165.87835</td>
<td align="right">401.67082</td>
<td align="right">504050.2</td>
<td align="right">204223.2</td>
<td align="right">168536.93</td>
<td align="right">8.871823</td>
</tr>
<tr class="odd">
<td align="left">Pt-14</td>
<td align="left">TRUE</td>
<td align="right">1106.8503</td>
<td align="right">372.72023</td>
<td align="right">222.01044</td>
<td align="right">784687.6</td>
<td align="right">334367.1</td>
<td align="right">98303.01</td>
<td align="right">12.835334</td>
</tr>
<tr class="even">
<td align="left">Pt-17</td>
<td align="left">TRUE</td>
<td align="right">718.4719</td>
<td align="right">242.59406</td>
<td align="right">355.69466</td>
<td align="right">604164.4</td>
<td align="right">244944.2</td>
<td align="right">144100.18</td>
<td align="right">3.665553</td>
</tr>
<tr class="odd">
<td align="left">Pt-18</td>
<td align="left">TRUE</td>
<td align="right">776.9947</td>
<td align="right">213.33267</td>
<td align="right">378.56799</td>
<td align="right">639572.0</td>
<td align="right">227939.5</td>
<td align="right">149633.26</td>
<td align="right">6.290179</td>
</tr>
<tr class="even">
<td align="left">Pt-19</td>
<td align="left">TRUE</td>
<td align="right">839.6388</td>
<td align="right">287.10433</td>
<td align="right">382.68932</td>
<td align="right">660850.9</td>
<td align="right">259437.0</td>
<td align="right">158289.08</td>
<td align="right">5.201948</td>
</tr>
<tr class="odd">
<td align="left">Pt-20</td>
<td align="left">TRUE</td>
<td align="right">601.2203</td>
<td align="right">288.54680</td>
<td align="right">382.68932</td>
<td align="right">552292.5</td>
<td align="right">256070.9</td>
<td align="right">166824.68</td>
<td align="right">4.807353</td>
</tr>
<tr class="even">
<td align="left">Pt-21</td>
<td align="left">TRUE</td>
<td align="right">653.3550</td>
<td align="right">221.57531</td>
<td align="right">380.62865</td>
<td align="right">573691.6</td>
<td align="right">227458.6</td>
<td align="right">153600.51</td>
<td align="right">2.656390</td>
</tr>
<tr class="odd">
<td align="left">Pt-23</td>
<td align="left">TRUE</td>
<td align="right">646.4883</td>
<td align="right">588.60129</td>
<td align="right">222.43882</td>
<td align="right">575568.7</td>
<td align="right">414728.5</td>
<td align="right">162492.58</td>
<td align="right">14.515807</td>
</tr>
<tr class="even">
<td align="left">Pt-24</td>
<td align="left">TRUE</td>
<td align="right">769.5130</td>
<td align="right">605.94266</td>
<td align="right">204.25736</td>
<td align="right">628557.3</td>
<td align="right">429391.3</td>
<td align="right">150296.75</td>
<td align="right">2.592245</td>
</tr>
<tr class="odd">
<td align="left">Pt-25</td>
<td align="left">TRUE</td>
<td align="right">1150.4870</td>
<td align="right">201.70284</td>
<td align="right">365.00699</td>
<td align="right">806460.8</td>
<td align="right">229605.7</td>
<td align="right">130248.64</td>
<td align="right">13.362692</td>
</tr>
<tr class="even">
<td align="left">Pt-26</td>
<td align="left">TRUE</td>
<td align="right">1045.9179</td>
<td align="right">168.05378</td>
<td align="right">215.08408</td>
<td align="right">758726.8</td>
<td align="right">253891.8</td>
<td align="right">60372.56</td>
<td align="right">2.592961</td>
</tr>
<tr class="odd">
<td align="left">Pt-27</td>
<td align="left">TRUE</td>
<td align="right">389.1564</td>
<td align="right">177.03002</td>
<td align="right">206.10784</td>
<td align="right">443130.5</td>
<td align="right">243562.0</td>
<td align="right">92329.64</td>
<td align="right">8.591221</td>
</tr>
<tr class="even">
<td align="left">Pt-39</td>
<td align="left">TRUE</td>
<td align="right">294.9652</td>
<td align="right">198.55742</td>
<td align="right">355.90246</td>
<td align="right">397489.3</td>
<td align="right">219837.0</td>
<td align="right">154312.24</td>
<td align="right">7.061507</td>
</tr>
<tr class="odd">
<td align="left">Pt-40</td>
<td align="left">TRUE</td>
<td align="right">241.6744</td>
<td align="right">211.20539</td>
<td align="right">350.83541</td>
<td align="right">374566.7</td>
<td align="right">240128.5</td>
<td align="right">154291.60</td>
<td align="right">7.200079</td>
</tr>
<tr class="even">
<td align="left">Pt-41</td>
<td align="left">TRUE</td>
<td align="right">370.7507</td>
<td align="right">378.18580</td>
<td align="right">217.87953</td>
<td align="right">427042.8</td>
<td align="right">327135.6</td>
<td align="right">129327.00</td>
<td align="right">2.181738</td>
</tr>
<tr class="odd">
<td align="left">Pt-42</td>
<td align="left">TRUE</td>
<td align="right">356.8177</td>
<td align="right">360.25507</td>
<td align="right">239.47496</td>
<td align="right">417693.5</td>
<td align="right">316017.5</td>
<td align="right">134633.36</td>
<td align="right">4.847158</td>
</tr>
<tr class="even">
<td align="left">Pt-43</td>
<td align="left">TRUE</td>
<td align="right">311.3398</td>
<td align="right">452.29866</td>
<td align="right">394.44954</td>
<td align="right">442448.7</td>
<td align="right">338329.6</td>
<td align="right">223884.56</td>
<td align="right">24.673536</td>
</tr>
<tr class="odd">
<td align="left">Pt-44</td>
<td align="left">TRUE</td>
<td align="right">435.6423</td>
<td align="right">511.76526</td>
<td align="right">303.65791</td>
<td align="right">476555.7</td>
<td align="right">338329.6</td>
<td align="right">192565.15</td>
<td align="right">19.237017</td>
</tr>
<tr class="even">
<td align="left">Pt-45</td>
<td align="left">TRUE</td>
<td align="right">325.9132</td>
<td align="right">597.71786</td>
<td align="right">158.23298</td>
<td align="right">413428.0</td>
<td align="right">417820.1</td>
<td align="right">149932.91</td>
<td align="right">21.649187</td>
</tr>
<tr class="odd">
<td align="left">Pt-46</td>
<td align="left">TRUE</td>
<td align="right">197.7791</td>
<td align="right">449.11545</td>
<td align="right">319.63260</td>
<td align="right">379721.1</td>
<td align="right">365104.0</td>
<td align="right">194728.93</td>
<td align="right">15.990273</td>
</tr>
<tr class="even">
<td align="left">Pt-47</td>
<td align="left">TRUE</td>
<td align="right">120.6732</td>
<td align="right">274.52403</td>
<td align="right">323.29304</td>
<td align="right">306977.7</td>
<td align="right">296201.8</td>
<td align="right">158477.26</td>
<td align="right">14.886355</td>
</tr>
<tr class="odd">
<td align="left">Pt-48</td>
<td align="left">TRUE</td>
<td align="right">162.5141</td>
<td align="right">275.24054</td>
<td align="right">425.51338</td>
<td align="right">358354.3</td>
<td align="right">244585.2</td>
<td align="right">203131.63</td>
<td align="right">16.122111</td>
</tr>
<tr class="even">
<td align="left">Pt-49</td>
<td align="left">TRUE</td>
<td align="right">413.3632</td>
<td align="right">161.16906</td>
<td align="right">316.82330</td>
<td align="right">455995.0</td>
<td align="right">219330.2</td>
<td align="right">129508.15</td>
<td align="right">4.643610</td>
</tr>
<tr class="odd">
<td align="left">Pt-50</td>
<td align="left">TRUE</td>
<td align="right">542.6337</td>
<td align="right">173.56902</td>
<td align="right">150.26896</td>
<td align="right">501073.6</td>
<td align="right">258902.8</td>
<td align="right">68029.46</td>
<td align="right">9.397889</td>
</tr>
<tr class="even">
<td align="left">Pt-51</td>
<td align="left">TRUE</td>
<td align="right">732.8606</td>
<td align="right">262.06885</td>
<td align="right">208.87088</td>
<td align="right">605899.8</td>
<td align="right">285350.0</td>
<td align="right">89498.26</td>
<td align="right">3.135272</td>
</tr>
<tr class="odd">
<td align="left">Pt-52</td>
<td align="left">TRUE</td>
<td align="right">763.4152</td>
<td align="right">262.35759</td>
<td align="right">225.77664</td>
<td align="right">622311.7</td>
<td align="right">278256.8</td>
<td align="right">91584.51</td>
<td align="right">5.725675</td>
</tr>
<tr class="even">
<td align="left">Pt-53</td>
<td align="left">TRUE</td>
<td align="right">673.4191</td>
<td align="right">235.90844</td>
<td align="right">112.99012</td>
<td align="right">579791.1</td>
<td align="right">293613.3</td>
<td align="right">48661.11</td>
<td align="right">8.988793</td>
</tr>
<tr class="odd">
<td align="left">Pt-54</td>
<td align="left">TRUE</td>
<td align="right">522.3014</td>
<td align="right">213.16795</td>
<td align="right">94.27100</td>
<td align="right">501220.4</td>
<td align="right">290557.8</td>
<td align="right">48661.11</td>
<td align="right">8.007639</td>
</tr>
<tr class="even">
<td align="left">Pt-55</td>
<td align="left">TRUE</td>
<td align="right">918.1357</td>
<td align="right">217.61283</td>
<td align="right">104.17984</td>
<td align="right">698302.0</td>
<td align="right">314347.2</td>
<td align="right">24435.13</td>
<td align="right">12.130931</td>
</tr>
<tr class="odd">
<td align="left">Pt-56</td>
<td align="left">TRUE</td>
<td align="right">1021.5445</td>
<td align="right">379.96095</td>
<td align="right">136.36467</td>
<td align="right">742073.3</td>
<td align="right">362250.9</td>
<td align="right">64369.84</td>
<td align="right">4.104513</td>
</tr>
<tr class="even">
<td align="left">Pt-57</td>
<td align="left">TRUE</td>
<td align="right">1212.4784</td>
<td align="right">422.50773</td>
<td align="right">128.28765</td>
<td align="right">817108.7</td>
<td align="right">368563.9</td>
<td align="right">87998.78</td>
<td align="right">18.177230</td>
</tr>
<tr class="odd">
<td align="left">Pt-58</td>
<td align="left">TRUE</td>
<td align="right">1249.0229</td>
<td align="right">401.20869</td>
<td align="right">365.68265</td>
<td align="right">829769.9</td>
<td align="right">313224.9</td>
<td align="right">176053.38</td>
<td align="right">4.574636</td>
</tr>
<tr class="even">
<td align="left">Pt-59</td>
<td align="left">TRUE</td>
<td align="right">1174.4594</td>
<td align="right">631.83024</td>
<td align="right">248.45789</td>
<td align="right">818414.3</td>
<td align="right">433119.5</td>
<td align="right">173412.53</td>
<td align="right">22.373505</td>
</tr>
<tr class="odd">
<td align="left">Pt-60</td>
<td align="left">TRUE</td>
<td align="right">1077.1313</td>
<td align="right">573.66563</td>
<td align="right">299.84596</td>
<td align="right">747375.4</td>
<td align="right">404862.4</td>
<td align="right">173412.53</td>
<td align="right">17.742575</td>
</tr>
<tr class="even">
<td align="left">Pt-61</td>
<td align="left">TRUE</td>
<td align="right">1112.7070</td>
<td align="right">339.48705</td>
<td align="right">401.72907</td>
<td align="right">756090.2</td>
<td align="right">286552.3</td>
<td align="right">173412.53</td>
<td align="right">19.347517</td>
</tr>
<tr class="odd">
<td align="left">Pt-62</td>
<td align="left">TRUE</td>
<td align="right">1306.1523</td>
<td align="right">263.30353</td>
<td align="right">411.07188</td>
<td align="right">859611.5</td>
<td align="right">246939.6</td>
<td align="right">173412.53</td>
<td align="right">7.594850</td>
</tr>
<tr class="even">
<td align="left">Pt-63</td>
<td align="left">TRUE</td>
<td align="right">1328.8859</td>
<td align="right">469.20296</td>
<td align="right">354.47855</td>
<td align="right">859687.9</td>
<td align="right">333999.7</td>
<td align="right">192126.24</td>
<td align="right">12.448687</td>
</tr>
<tr class="odd">
<td align="left">Pt-64</td>
<td align="left">TRUE</td>
<td align="right">549.6954</td>
<td align="right">583.20048</td>
<td align="right">162.32429</td>
<td align="right">509921.5</td>
<td align="right">403489.6</td>
<td align="right">147127.08</td>
<td align="right">12.925469</td>
</tr>
<tr class="even">
<td align="left">Pt-65</td>
<td align="left">TRUE</td>
<td align="right">765.1116</td>
<td align="right">188.70754</td>
<td align="right">178.33252</td>
<td align="right">616575.5</td>
<td align="right">271178.7</td>
<td align="right">58176.36</td>
<td align="right">7.625301</td>
</tr>
<tr class="odd">
<td align="left">Pt-66</td>
<td align="left">TRUE</td>
<td align="right">785.3950</td>
<td align="right">425.64347</td>
<td align="right">15.25080</td>
<td align="right">632860.0</td>
<td align="right">399076.2</td>
<td align="right">37528.28</td>
<td align="right">6.358484</td>
</tr>
<tr class="even">
<td align="left">Pt-67</td>
<td align="left">TRUE</td>
<td align="right">491.9622</td>
<td align="right">447.69119</td>
<td align="right">309.37694</td>
<td align="right">489103.1</td>
<td align="right">329705.4</td>
<td align="right">176917.26</td>
<td align="right">13.309858</td>
</tr>
<tr class="odd">
<td align="left">Pt-68</td>
<td align="left">TRUE</td>
<td align="right">636.6000</td>
<td align="right">582.23100</td>
<td align="right">304.45079</td>
<td align="right">548824.8</td>
<td align="right">380895.4</td>
<td align="right">183068.00</td>
<td align="right">18.791822</td>
</tr>
<tr class="even">
<td align="left">Pt-69</td>
<td align="left">TRUE</td>
<td align="right">751.5368</td>
<td align="right">622.07216</td>
<td align="right">324.54432</td>
<td align="right">622633.7</td>
<td align="right">397958.8</td>
<td align="right">198940.87</td>
<td align="right">10.800934</td>
</tr>
<tr class="odd">
<td align="left">Pt-70</td>
<td align="left">TRUE</td>
<td align="right">248.6964</td>
<td align="right">386.77664</td>
<td align="right">133.64117</td>
<td align="right">375957.0</td>
<td align="right">360354.0</td>
<td align="right">115925.73</td>
<td align="right">14.752904</td>
</tr>
<tr class="even">
<td align="left">Pt-71</td>
<td align="left">TRUE</td>
<td align="right">371.3233</td>
<td align="right">241.13746</td>
<td align="right">246.95856</td>
<td align="right">425172.9</td>
<td align="right">260481.9</td>
<td align="right">115925.73</td>
<td align="right">6.101949</td>
</tr>
<tr class="odd">
<td align="left">Pt-72</td>
<td align="left">TRUE</td>
<td align="right">125.3698</td>
<td align="right">356.45723</td>
<td align="right">424.67776</td>
<td align="right">349795.9</td>
<td align="right">298764.2</td>
<td align="right">229860.66</td>
<td align="right">13.397052</td>
</tr>
<tr class="even">
<td align="left">Pt-73</td>
<td align="left">TRUE</td>
<td align="right">366.0449</td>
<td align="right">417.33611</td>
<td align="right">390.53431</td>
<td align="right">447017.2</td>
<td align="right">298565.8</td>
<td align="right">211606.86</td>
<td align="right">8.953431</td>
</tr>
<tr class="odd">
<td align="left">Pt-74</td>
<td align="left">TRUE</td>
<td align="right">297.1745</td>
<td align="right">286.05935</td>
<td align="right">401.86582</td>
<td align="right">401391.2</td>
<td align="right">252122.0</td>
<td align="right">196178.45</td>
<td align="right">12.326181</td>
</tr>
<tr class="even">
<td align="left">Pt-75</td>
<td align="left">TRUE</td>
<td align="right">120.6515</td>
<td align="right">261.44368</td>
<td align="right">422.62512</td>
<td align="right">307822.1</td>
<td align="right">252122.0</td>
<td align="right">202694.69</td>
<td align="right">19.538183</td>
</tr>
<tr class="odd">
<td align="left">Pt-76</td>
<td align="left">TRUE</td>
<td align="right">371.7625</td>
<td align="right">362.30048</td>
<td align="right">386.60631</td>
<td align="right">445986.7</td>
<td align="right">279612.4</td>
<td align="right">193734.86</td>
<td align="right">5.209407</td>
</tr>
<tr class="even">
<td align="left">Pt-77</td>
<td align="left">TRUE</td>
<td align="right">863.6581</td>
<td align="right">20.51800</td>
<td align="right">305.28403</td>
<td align="right">666626.3</td>
<td align="right">172167.2</td>
<td align="right">73062.24</td>
<td align="right">6.422350</td>
</tr>
<tr class="odd">
<td align="left">Pt-78</td>
<td align="left">TRUE</td>
<td align="right">877.3450</td>
<td align="right">69.27787</td>
<td align="right">262.22208</td>
<td align="right">675880.3</td>
<td align="right">195927.0</td>
<td align="right">63101.97</td>
<td align="right">4.434200</td>
</tr>
<tr class="even">
<td align="left">Pt-79</td>
<td align="left">TRUE</td>
<td align="right">887.6924</td>
<td align="right">116.68930</td>
<td align="right">198.29597</td>
<td align="right">683285.2</td>
<td align="right">236316.9</td>
<td align="right">46525.29</td>
<td align="right">2.511654</td>
</tr>
<tr class="odd">
<td align="left">Pt-80</td>
<td align="left">TRUE</td>
<td align="right">456.7993</td>
<td align="right">163.75185</td>
<td align="right">410.38070</td>
<td align="right">486884.6</td>
<td align="right">200114.5</td>
<td align="right">167707.33</td>
<td align="right">4.602266</td>
</tr>
<tr class="even">
<td align="left">Pt-81</td>
<td align="left">TRUE</td>
<td align="right">457.2808</td>
<td align="right">92.26043</td>
<td align="right">414.81480</td>
<td align="right">486884.6</td>
<td align="right">170297.8</td>
<td align="right">145557.76</td>
<td align="right">9.982881</td>
</tr>
<tr class="odd">
<td align="left">Pt-82</td>
<td align="left">TRUE</td>
<td align="right">543.1608</td>
<td align="right">46.12096</td>
<td align="right">309.74346</td>
<td align="right">514997.5</td>
<td align="right">166251.2</td>
<td align="right">96573.13</td>
<td align="right">5.349113</td>
</tr>
<tr class="even">
<td align="left">Pt-83</td>
<td align="left">TRUE</td>
<td align="right">610.5969</td>
<td align="right">134.29354</td>
<td align="right">334.08200</td>
<td align="right">548304.2</td>
<td align="right">204859.4</td>
<td align="right">120887.29</td>
<td align="right">3.590523</td>
</tr>
<tr class="odd">
<td align="left">Pt-84</td>
<td align="left">TRUE</td>
<td align="right">687.3255</td>
<td align="right">150.56257</td>
<td align="right">339.67920</td>
<td align="right">590275.8</td>
<td align="right">207454.9</td>
<td align="right">120887.29</td>
<td align="right">2.896198</td>
</tr>
<tr class="even">
<td align="left">Pt-85</td>
<td align="left">TRUE</td>
<td align="right">637.3402</td>
<td align="right">37.40585</td>
<td align="right">246.20518</td>
<td align="right">558273.3</td>
<td align="right">175584.6</td>
<td align="right">62700.93</td>
<td align="right">6.317059</td>
</tr>
<tr class="odd">
<td align="left">Pt-86</td>
<td align="left">TRUE</td>
<td align="right">601.4145</td>
<td align="right">48.82580</td>
<td align="right">235.55270</td>
<td align="right">530820.9</td>
<td align="right">183745.3</td>
<td align="right">62633.07</td>
<td align="right">6.675230</td>
</tr>
</tbody>
</table>
<p>And then visualise them in 3D, colouring each point by the magnitude of the delta.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">clear3d</span>()
<span class="kw">view3d</span>(<span class="dt">userMatrix=</span>rgl::<span class="kw">rotationMatrix</span>(<span class="dt">angle =</span> pi, <span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">zoom=</span><span class="fl">0.7</span>)
jet.colors &lt;-
<span class="st">  </span><span class="kw">colorRampPalette</span>(<span class="kw">c</span>(<span class="st">"#00007F"</span>, <span class="st">"blue"</span>, <span class="st">"#007FFF"</span>, <span class="st">"cyan"</span>,
                     <span class="st">"#7FFF7F"</span>, <span class="st">"yellow"</span>, <span class="st">"#FF7F00"</span>, <span class="st">"red"</span>, <span class="st">"#7F0000"</span>))

<span class="kw">plot3d</span>(JFRC2013)
<span class="kw">spheres3d</span>(xyz, <span class="dt">col =</span> <span class="kw">jet.colors</span>(<span class="dv">10</span>)[<span class="kw">cut</span>(deltas, <span class="dv">10</span>)], <span class="dt">radius =</span> <span class="dv">4</span>)
<span class="co"># nb these are numbered from 0 like the elm landmarks</span>
<span class="kw">texts3d</span>(xyz, <span class="dt">texts =</span> <span class="dv">1</span>:<span class="kw">nrow</span>(xyz)-<span class="dv">1</span>, <span class="dt">adj =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</code></pre></div>
<p><img src="landmarks_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
<p>Based on this, I would definitely suggest checking the following landmarks</p>
<p>59/32 27 30 52 18</p>
<p>Compare the leave one out landmark position with manually defined position</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">clear3d</span>()
<span class="kw">view3d</span>(<span class="dt">userMatrix=</span>rgl::<span class="kw">rotationMatrix</span>(<span class="dt">angle =</span> pi, <span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">zoom=</span><span class="fl">0.7</span>)
for(i in <span class="dv">1</span>:<span class="kw">nrow</span>(xyz)){
  <span class="kw">segments3d</span>(<span class="kw">rbind</span>(xyz[i, , <span class="dt">drop=</span><span class="ot">FALSE</span>], xyzt.loo[i, , <span class="dt">drop=</span><span class="ot">FALSE</span>]), <span class="dt">col=</span><span class="kw">jet.colors</span>(<span class="dv">10</span>)[<span class="kw">cut</span>(deltas, <span class="dv">10</span>)][i], <span class="dt">lwd=</span><span class="dv">3</span>)
}
<span class="kw">points3d</span>(xyz)
<span class="kw">texts3d</span>(xyz, <span class="dt">texts =</span> <span class="dv">1</span>:<span class="kw">nrow</span>(xyz)-<span class="dv">1</span>, <span class="dt">adj =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))
<span class="kw">plot3d</span>(JFRC2013)</code></pre></div>
<p><img src="landmarks_files/figure-html/unnamed-chunk-7-1.png" width="480"></p>
<p>Now of course this is not just a measure of consistency in each landmark point, but it will also depend strongly on the extent to which the neighbouring points can define the required registration; in areas requiring substantial non-rigid deformation this may be a problem; this will be further emphasised when the neighbouring points are distant. We can check the latter point like so:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(nabor)
nearest3=<span class="kw">rowMeans</span>(nabor::<span class="kw">knn</span>(xyz, <span class="dt">k=</span><span class="dv">4</span>)$nn.dists[,-<span class="dv">1</span>])
<span class="kw">plot</span>(deltas~nearest3)
deltabynearest3=<span class="kw">lm</span>(deltas~nearest3)
<span class="kw">abline</span>(deltabynearest3)</code></pre></div>
<p><img src="landmarks_files/figure-html/unnamed-chunk-8-1.png" width="480"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(deltabynearest3)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = deltas ~ nearest3)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -10.9280  -2.5874  -0.5281   2.4646  16.0718 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  2.26996    1.69207   1.342    0.184    
## nearest3     0.16138    0.03635   4.440 3.33e-05 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 4.993 on 69 degrees of freedom
## Multiple R-squared:  0.2222, Adjusted R-squared:  0.211 
## F-statistic: 19.71 on 1 and 69 DF,  p-value: 3.331e-05</code></pre>
<p>So there is a correlation between neighbour distance and our calculated delta, but with an R^2 of about 0.21 it’s not super strong. Furthermore it could also be explained by Davi placing more landmarks in areas where he is more certain.</p>
<p>Perhaps the ideal thing would be to find a set of landmarks on one side of the brain and then find exactly the same landmarks on the other side of the brain. For the JFRC2013 brain we can exactly mirror points from one side to the other using an image-based registration distributed with the <code>nat.flybrains</code> package.</p>
<p>We can find the mirror image position of all the points that we used like so:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#  nb this is conditioned on being able to find CMTK</span>
if(<span class="kw">isTRUE</span>(<span class="kw">nzchar</span>(<span class="kw">cmtk.bindir</span>()))){
  xyzm=<span class="kw">mirror_brain</span>(xyz, <span class="dt">brain =</span> JFRC2013)
  
  <span class="kw">clear3d</span>()
  <span class="kw">spheres3d</span>(xyz, <span class="dt">col=</span><span class="st">'red'</span>, <span class="dt">rad=</span><span class="dv">2</span>)
  <span class="kw">spheres3d</span>(xyzm, <span class="dt">col=</span><span class="st">'green'</span>, <span class="dt">rad=</span><span class="dv">2</span>)
  <span class="kw">plot3d</span>(JFRC2013)
  <span class="kw">view3d</span>(<span class="dt">userMatrix=</span>rgl::<span class="kw">rotationMatrix</span>(<span class="dt">angle =</span> pi, <span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">zoom=</span><span class="fl">0.7</span>)

}</code></pre></div>
<p><img src="landmarks_files/figure-html/unnamed-chunk-9-1.png" width="480"></p>
<p>One could then write out a table of landmarks including these mirrored positions like so:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">xyzm.pixels=<span class="kw">scale</span>(xyzm, <span class="dt">scale =</span> <span class="kw">voxdims</span>(JFRC2013), <span class="dt">center =</span> <span class="ot">FALSE</span>)
<span class="kw">colnames</span>(xyzm.pixels)=<span class="kw">c</span>(<span class="st">"XM"</span>,<span class="st">"YM"</span>,<span class="st">"ZM"</span>)
<span class="kw">write.table</span>(<span class="kw">cbind</span>(elm.landmarks, xyzm.pixels), <span class="st">'elm.landmarks-with-mirror.tsv'</span>,
            <span class="dt">col.names =</span> T, <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dt">row.names =</span> F)</code></pre></div>
<p>If one were then to take the mirror image landmarks in JFRC2013 space and manually pick the corresponding locations in EM space, one should be able to compare two different paths to the same point (one mirroring in FAFB, the other mirroring in JFRC2013) and see whether there is a difference in the calculated position. Differences would presumably reflect the uncertainty in picking positions in the EM volume (and a small contribution from the mirroring uncertainty in JFRC2013, which nevertheless expect to be &lt;1 µm based on analysis in <a href="https://doi.org/10.1101/006353">Manton et al 2014</a>).</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#intro">Intro</a></li>
      <li><a href="#landmarks">Landmarks</a></li>
      <li><a href="#landmamarks-based-transform">Landmamarks based transform</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Gregory Jefferis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
